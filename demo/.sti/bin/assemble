#!/bin/sh


# Jenkins location of artifact
APPLICATION_ARTIFACT_URL=http://jenkins.innovation.redhat.com:8080/job/Ticket-Monster-Build/lastSuccessfulBuild/artifact/demo/target/ticket-monster.war


# Source code provided to STI is at ${HOME}/source
LOCAL_SOURCE_DIR=${HOME}/source
mkdir -p $LOCAL_SOURCE_DIR

# Resulting WAR files will be deployed to /opt/eap/standalone/deployments
DEPLOY_DIR=$JBOSS_HOME/standalone/deployments

# JBoss AS data dir. Can be overridden.
DATA_DIR=${DATA_DIR-$JBOSS_HOME/data}

# the subdirectory within LOCAL_SOURCE_DIR from where we should copy build
# artifacts (*.war, *.jar)
ARTIFACT_DIR=${ARTIFACT_DIR-target}

function copy_artifacts() {
  if [ -d $LOCAL_SOURCE_DIR/$1 ]; then
    echo "Copying all WAR and EAR artifacts from $LOCAL_SOURCE_DIR/$1 directory into $DEPLOY_DIR for later deployment..."
    cp -v $LOCAL_SOURCE_DIR/$1/*.jar $LOCAL_SOURCE_DIR/$1/*.war $LOCAL_SOURCE_DIR/$1/*.ear $DEPLOY_DIR 2> /dev/null
  fi
}

# Copy the source for version
cp -ad /tmp/src/* $LOCAL_SOURCE_DIR

APP_VERSION="NADA"

if [ -f "$LOCAL_SOURCE_DIR/pom.xml" ]; then
  pushd $LOCAL_SOURCE_DIR &> /dev/null
  echo "Found pom.xml..."
  APP_VERSION=`mvn help:evaluate -Dexpression=project.version | grep -v "KB" | grep -v "Download" | grep -v "[INFO]"`
  echo "TicketMonster version is " $APP_VERSION "....."
fi


# Copy (probably binary) artifacts from the deployments/
# directory to the $JBOSS_HOME/standalone/deployments/
# directory for later deployment
copy_artifacts "deployments"


echo "Copying artifact to deployment root " ${APPLICATION_ARTIFACT_URL}
curl -o ${DEPLOY_DIR}/ROOT.war -O ${APPLICATION_ARTIFACT_URL}


exit 0
